<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<!-- DataTables CSS & JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<div class="container py-4">
    <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="mb-4">Role Management</h3>
        <button class="btn btn-primary mb-3" id="openModal">Add Role</button>

        <table class="table table-bordered bg-white" id="roleTableWrapper">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Role Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="roleTable"></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="roleForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="roleId">
                <div class="mb-3">
                    <label for="roleName" class="form-label">Role Name</label>
                    <input type="text" class="form-control" id="roleName" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" type="submit">Save</button>
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    const api = "http://127.0.0.1:8000/roles/roles/";
    let modal;

    $(document).ready(function () {
      modal = new bootstrap.Modal(document.getElementById("roleModal"));
      loadRoles();

      $('#openModal').click(function () {
        $('#roleId').val('');
        $('#roleName').val('');
        $('.modal-title').text('Add Role');
        modal.show();
      });

      $('#roleForm').submit(function (e) {
        e.preventDefault();
        const id = $('#roleId').val();
        const name = $('#roleName').val().trim();
        if (!name) return;

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${api}${id}` : api;

        $.ajax({
          url: url,
          method: method,
          contentType: 'application/json',
          data: JSON.stringify({ name }),
          success: function () {
            modal.hide();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Saved successfully', timer: 2000, showConfirmButton: false });
            loadRoles();
          },
          error: function () {
            Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: 'Failed to save', timer: 2000, showConfirmButton: false });
          }
        });
      });
    });

    function loadRoles() {
      $.get(api, function (data) {
        const table = $("#roleTableWrapper").DataTable();

        // Clear and destroy existing DataTable
        table.clear().destroy();

        const tbody = $('#roleTable');
        tbody.empty();

        data.forEach(role => {
          tbody.append(`
            <tr>
              <td>${role.id}</td>
              <td>${role.name}</td>
              <td>
                <button class="btn btn-sm btn-warning me-1" onclick="editRole(${role.id}, '${role.name}')">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteRole(${role.id})">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          `);
        });

        // Reinitialize DataTable
        $("#roleTableWrapper").DataTable();
      });
    }


    function editRole(id, name) {
      $('#roleId').val(id);
      $('#roleName').val(name);
      $('.modal-title').text('Update Role');
      modal.show();
    }

    function deleteRole(id) {
      Swal.fire({
        title: 'Are you sure?',
        text: 'This will permanently delete the role.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!'
      }).then(result => {
        if (result.isConfirmed) {
          $.ajax({
            url: `${api}${id}`,
            method: 'DELETE',
            success: function () {
              Swal.fire({ toast: true, position: 'top-end',icon: 'success', title: 'Deleted', timer: 2000, showConfirmButton: false });
              loadRoles();
            },
            error: function () {
              Swal.fire({ toast: true, position: 'top-end',icon: 'error', title: 'Failed to delete', timer: 2000, showConfirmButton: false });
            }
          });
        }
      });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
